ffin.pitch=-pi/10;ffin.roll=2*pi/5;ffin.adj.up=-12;ffin.adj.lat=-15;ffin.onset=287;
dfin.pitch=-55*pi/180;dfin.adj.up=150;dfin.onset=310+50;
hfin.pitch=0;hfin.onset=322;hfin.adj.up=-50;hfin.adj.lat=-70;
afin.onset=563;afin.adj.up=25;
d2fin.pitch=-35*pi/180;d2fin.onset=563-10;d2fin.adj.up=180
if(R.Version()$os == "linux-gnu"){
setwd("/mnt/p/My Documents/MANU/Paleomass2/R/")
} else {
setwd("P:/My Documents/MANU/Paleomass2/R/")
}
Fname.Add <- "voxelized"
if(Interpolate) Fname.Add <- "interpolated"
Clean.Tol <- 2 * (2^0.5) * tip.radius
qtr.round.pos <- round(a.per.slice/4,0)
qtr.round.neg <- a.per.slice-qtr.round.pos
hlf.round <- round(a.per.slice/2,0)
if(Test.Run) {ceph.onset = 0; ffin.onset = 50; dfin.onset=100;
d2fin.onset = 150; hfin.onset = 800; afin.onset = 850; cfin.onset = 900;
cfin.adj.up = 0; cfin.pitch = 0; cfin.roll = 0;
dfin.adj.up = 0; dfin.pitch = 0;
d2fin.adj.up = 0; d2fin.pitch = 0; d2fin.roll = 0;
ffin.adj.lat = 0; ffin.adj.up = 0; ffin.pitch = 0; ffin.roll = 0;
hfin.adj.lat = 0; hfin.adj.up = 0; hfin.pitch = 0; hfin.roll = 0;
afin.adj.up = 0; afin.pitch = 0;
ceph.adj.up = 0; ceph.pitch = 0; ceph.roll = pi/2;
}
### Defining result-saving structure
Chars <- c("volume [voxel]","area [pixel^2]")
Chars.Complete <- c("volume [voxel]","area [pixel^2]","volume [m^3]",
"area [m^2]","mass.freshwater (kg)",paste0("mass.",dens," (kg)"))
Parts <- c(paste0("body",n1),paste0("body",n2),"Cfin","Dfin","ffinR","ffinL",
"hfinR","hfinL","D2fin","afin","ceph")
Parts.Complete <- c(paste0("Body_n=",n1),paste0("Body_n=",n2),"Caudal_fin",
"Dorsal_fin","Forefin_R","Forefin_L","HinDfin_R","HinDfin_L",
"2nd_Dorsal_Fin","Anal_Fin","Cephalofoil",paste0("Total_n=",n1),
paste0("Total_n=",n2),"Total_mean")
results <- matrix(,length(Parts),length(Chars),dimnames=(list(Parts,Chars)))
### Checking body parts that exist
BodyL <- file.exists(paste0("./",Folder,"/",BodyL.File,File.Ext))
BodyV <- file.exists(paste0("./",Folder,"/",BodyV.File,File.Ext))
Ffin <- file.exists(paste0("./",Folder,"/",Ffin.File,File.Ext))
Hfin <- file.exists(paste0("./",Folder,"/",Hfin.File,File.Ext))
Cfin <- file.exists(paste0("./",Folder,"/",Cfin.File,File.Ext))
Dfin <- file.exists(paste0("./",Folder,"/",Dfin.File,File.Ext))
D2fin <- file.exists(paste0("./",Folder,"/",D2fin.File,File.Ext))
Afin <- file.exists(paste0("./",Folder,"/",Afin.File,File.Ext))
Ceph <- file.exists(paste0("./",Folder,"/",Ceph.File,File.Ext))
if(BodyL) {print("Body lateral view found")}else{stop("No file for body lateral view")}
if(BodyV) {print("Body ventral view found")}else{stop("No file for body ventral view")}
if(Ffin) print("Forefin/pectoral fin/pectoral flipper found")
if(Hfin) print("Hindfin/pelvic fin/pelvic flipper found")
if(Cfin) print("Caudal fin found")
if(Dfin) print("Dorsal fin found")
if(D2fin) print("Second dorsal fin found")
if(Afin) print("Anal fin found")
if(Ceph) print("Cephalofoil found")
### Image Reading
img.lat <- imager::load.image(paste0("./",Folder,"/",BodyL.File,File.Ext))
img.dv <- imager::load.image(paste0("./",Folder,"/",BodyV.File,File.Ext))
if(Ffin) img.ff <- imager::load.image(paste0("./",Folder,"/",Ffin.File,File.Ext))
if(Hfin) img.hf <- imager::load.image(paste0("./",Folder,"/",Hfin.File,File.Ext))
if(Cfin) img.cf <- imager::load.image(paste0("./",Folder,"/",Cfin.File,File.Ext))
if(Dfin) img.df <- imager::load.image(paste0("./",Folder,"/",Dfin.File,File.Ext))
if(D2fin) img.d2 <- imager::load.image(paste0("./",Folder,"/",D2fin.File,File.Ext))
if(Afin) img.af <- imager::load.image(paste0("./",Folder,"/",Afin.File,File.Ext))
if(Ceph) img.ce <- imager::load.image(paste0("./",Folder,"/",Ceph.File,File.Ext))
### Make the images black and white
mx.lat <- t(round(img.lat[,,1,1],0))
mx.dv <- t(round(img.dv[,,1,1],0))
if(Ffin) mx.ff <- t(round(img.ff[,,1,1],0))
if(Hfin) mx.hf <- t(round(img.hf[,,1,1],0))
if(Cfin) mx.cf <- t(round(img.cf[,,1,1],0))
if(Dfin) mx.df <- t(round(img.df[,,1,1],0))
if(D2fin) mx.d2 <- t(round(img.d2[,,1,1],0))
if(Afin) mx.af <- t(round(img.af[,,1,1],0))
if(Ceph) mx.ce <- t(round(img.ce[,,1,1],0))
### Outline Digitization
dat.lat <- topbottom(mx.lat,Add.Tip=Add.Tip,tip.radius=tip.radius)
dat.dv <- topbottom(mx.dv,Add.Tip=Add.Tip,tip.radius=tip.radius)
if(Ffin) dat.ff <- antpost(mx.ff,Add.Tip=Add.Tip,Origin="Bottom")
if(Hfin) dat.hf <- antpost(mx.hf,Add.Tip=Add.Tip,Origin="Bottom")
if(Cfin) dat.cf <- antpost(mx.cf,Add.Tip=Add.Tip)
if(Dfin) dat.df <- antpost(mx.df,Add.Tip=Add.Tip)
if(D2fin) dat.d2 <- antpost(mx.d2,Add.Tip=Add.Tip)
if(Afin) dat.af <- antpost(mx.af,Add.Tip=Add.Tip,Origin="Bottom")
if(Ceph) dat.ce <- antpost(mx.ce,Add.Tip=Add.Tip)
### Keeping a record of original body length in pixels
bal.px <- nrow(dat.lat)
px.L <- body.axis.l/nrow(dat.lat)
if(Add.Tip) px.L <- body.axis.l/nrow(dat.lat-2)
### Whether to translate all elements vertically to center the body
y.shift <- 0
if(Body.Y.Centering) y.shift <- -mean(range(dat.lat[,2:3]))
### Interpolation, if Interpolate=TRUE
if(Interpolate){
dat.lat <- locfit_interpolate(dat.lat,Nseg=N.Body.Slice,Use.Weight=F,n.out=n.body.slice,nn=nn.b)
dat.dv <-locfit_interpolate(dat.dv,Nseg=N.Body.Slice,Use.Weight=F,n.out=n.body.slice,nn=nn.b)
if(Ffin) dat.ff <- locfit_interpolate(dat.ff,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Hfin) dat.hf <- locfit_interpolate(dat.hf,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Cfin) dat.cf <- locfit_interpolate(dat.cf,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Dfin) dat.df <- locfit_interpolate(dat.df,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(D2fin) dat.d2 <- locfit_interpolate(dat.d2,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Afin) dat.af <- locfit_interpolate(dat.af,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Ceph) dat.ce <- locfit_interpolate(dat.ce,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
}
### Body when n=n1
mesh.body.1 <- mesh_body(dat.lat,dat.dv,nb=n1,X.center=0,Y.center=y.shift,
Z.onset=0,a.per.slice=a.per.slice,Mesh.Col=Mesh.Col,tol=Clean.Tol)
if(Save.Part.Mesh) Rvcg::vcgPlyWrite(mesh.body.1,paste0("./",Folder,"/Body_",n1,"_",
Fname.Add,".ply"),writeCol=F,writeNormals=T)
results[1,2] <- Rvcg::vcgArea(mesh.body.1)
try(results[1,1] <- Rvcg::vcgVolume(mesh.body.1))
### Body when n=n2
mesh.body.2 <- mesh_body(dat.lat,dat.dv,nb=n2,X.center=0,Y.center=y.shift,
Z.onset=0,a.per.slice=a.per.slice,Mesh.Col=Mesh.Col,tol=Clean.Tol)
if(Save.Part.Mesh) Rvcg::vcgPlyWrite(mesh.body.2,paste0("./",Folder,"/Body_",n2,"_",
Fname.Add,".ply"),writeCol=F,writeNormals=T)
results[2,2] <- Rvcg::vcgArea(mesh.body.2)
try(results[2,1] <- Rvcg::vcgVolume(mesh.body.2))
### Caudal Fluke
# Xc, Yc, Zc    Global coordinates for the caudal fluke.
# .onset        Anterior margin center of the fluke in global coordinate
if(Cfin){
# cfin.atip.y <- floor(colMeans(dat.cf[dat.cf[,2]==min(dat.cf[,2]),])[1])
cfin.atip.y <- dist(range(dat.cf[,1]))/2
# cfin.atip.y <- dat.dv[nrow(dat.dv),4]
cfin.base <- c(0, cfin.adj.up + cfin.atip.y + y.shift, cfin.onset * bal.px)
Yc.onset <- cfin.base[2] #+dat.lat[nrow(dat.lat),4]
Xc.onset <- cfin.base[1]
Zc.onset <- cfin.base[3]
mesh.cf <- mesh_foil(dat.cf,tf=cfin.thick,X.onset=Xc.onset,Y.onset=Yc.onset,
Z.onset=Zc.onset,tol=Clean.Tol,Thickest=0.5,Center=T,
a.per.slice=a.per.slice,Mesh.Col=Mesh.Col)
Mesh.Cfin <- mesh.cf$Mesh
### Fin roll, pitch, and yaw
#roll
Mesh.Cfin <- Morpho::rotaxis3d(Mesh.Cfin,cfin.base+c(0,0,100),
cfin.base+c(0,0,-100),cfin.roll)
#pitch
Mesh.Cfin <- Morpho::rotaxis3d(Mesh.Cfin,cfin.base+c(100,0,0),
cfin.base+c(-100,0,0),cfin.pitch)
#yaw
Mesh.Cfin <- Morpho::rotaxis3d(Mesh.Cfin,cfin.base+c(0,100,0),
cfin.base+c(0,-100,0),cfin.yaw)
Mesh.whole <- merge(mesh.body.1,Mesh.Cfin)
plot3d(Mesh.whole,col="royalblue",asp="iso")
### Mesh saving
if(Save.Part.Mesh) Rvcg::vcgPlyWrite(Mesh.Cfin,paste0("./",Folder,"/CaudalFluke_",
Fname.Add,".ply"),writeCol=F,writeNormals=F)
### Measure
results[3,2] <- Rvcg::vcgArea(Mesh.Cfin)
try(results[3,1] <- Rvcg::vcgVolume(Mesh.Cfin))
}
library(rgl)
Fname.Add <- "voxelized"
if(Interpolate) Fname.Add <- "interpolated"
Clean.Tol <- 2 * (2^0.5) * tip.radius
qtr.round.pos <- round(a.per.slice/4,0)
qtr.round.neg <- a.per.slice-qtr.round.pos
hlf.round <- round(a.per.slice/2,0)
if(Test.Run) {ceph.onset = 0; ffin.onset = 50; dfin.onset=100;
d2fin.onset = 150; hfin.onset = 800; afin.onset = 850; cfin.onset = 900;
cfin.adj.up = 0; cfin.pitch = 0; cfin.roll = 0;
dfin.adj.up = 0; dfin.pitch = 0;
d2fin.adj.up = 0; d2fin.pitch = 0; d2fin.roll = 0;
ffin.adj.lat = 0; ffin.adj.up = 0; ffin.pitch = 0; ffin.roll = 0;
hfin.adj.lat = 0; hfin.adj.up = 0; hfin.pitch = 0; hfin.roll = 0;
afin.adj.up = 0; afin.pitch = 0;
ceph.adj.up = 0; ceph.pitch = 0; ceph.roll = pi/2;
}
### Defining result-saving structure
Chars <- c("volume [voxel]","area [pixel^2]")
Chars.Complete <- c("volume [voxel]","area [pixel^2]","volume [m^3]",
"area [m^2]","mass.freshwater (kg)",paste0("mass.",dens," (kg)"))
Parts <- c(paste0("body",n1),paste0("body",n2),"Cfin","Dfin","ffinR","ffinL",
"hfinR","hfinL","D2fin","afin","ceph")
Parts.Complete <- c(paste0("Body_n=",n1),paste0("Body_n=",n2),"Caudal_fin",
"Dorsal_fin","Forefin_R","Forefin_L","HinDfin_R","HinDfin_L",
"2nd_Dorsal_Fin","Anal_Fin","Cephalofoil",paste0("Total_n=",n1),
paste0("Total_n=",n2),"Total_mean")
results <- matrix(,length(Parts),length(Chars),dimnames=(list(Parts,Chars)))
### Checking body parts that exist
BodyL <- file.exists(paste0("./",Folder,"/",BodyL.File,File.Ext))
BodyV <- file.exists(paste0("./",Folder,"/",BodyV.File,File.Ext))
Ffin <- file.exists(paste0("./",Folder,"/",Ffin.File,File.Ext))
Hfin <- file.exists(paste0("./",Folder,"/",Hfin.File,File.Ext))
Cfin <- file.exists(paste0("./",Folder,"/",Cfin.File,File.Ext))
Dfin <- file.exists(paste0("./",Folder,"/",Dfin.File,File.Ext))
D2fin <- file.exists(paste0("./",Folder,"/",D2fin.File,File.Ext))
Afin <- file.exists(paste0("./",Folder,"/",Afin.File,File.Ext))
Ceph <- file.exists(paste0("./",Folder,"/",Ceph.File,File.Ext))
if(BodyL) {print("Body lateral view found")}else{stop("No file for body lateral view")}
if(BodyV) {print("Body ventral view found")}else{stop("No file for body ventral view")}
if(Ffin) print("Forefin/pectoral fin/pectoral flipper found")
if(Hfin) print("Hindfin/pelvic fin/pelvic flipper found")
if(Cfin) print("Caudal fin found")
if(Dfin) print("Dorsal fin found")
if(D2fin) print("Second dorsal fin found")
if(Afin) print("Anal fin found")
if(Ceph) print("Cephalofoil found")
### Image Reading
img.lat <- imager::load.image(paste0("./",Folder,"/",BodyL.File,File.Ext))
img.dv <- imager::load.image(paste0("./",Folder,"/",BodyV.File,File.Ext))
if(Ffin) img.ff <- imager::load.image(paste0("./",Folder,"/",Ffin.File,File.Ext))
if(Hfin) img.hf <- imager::load.image(paste0("./",Folder,"/",Hfin.File,File.Ext))
if(Cfin) img.cf <- imager::load.image(paste0("./",Folder,"/",Cfin.File,File.Ext))
if(Dfin) img.df <- imager::load.image(paste0("./",Folder,"/",Dfin.File,File.Ext))
if(D2fin) img.d2 <- imager::load.image(paste0("./",Folder,"/",D2fin.File,File.Ext))
if(Afin) img.af <- imager::load.image(paste0("./",Folder,"/",Afin.File,File.Ext))
if(Ceph) img.ce <- imager::load.image(paste0("./",Folder,"/",Ceph.File,File.Ext))
### Make the images black and white
mx.lat <- t(round(img.lat[,,1,1],0))
mx.dv <- t(round(img.dv[,,1,1],0))
if(Ffin) mx.ff <- t(round(img.ff[,,1,1],0))
if(Hfin) mx.hf <- t(round(img.hf[,,1,1],0))
if(Cfin) mx.cf <- t(round(img.cf[,,1,1],0))
if(Dfin) mx.df <- t(round(img.df[,,1,1],0))
if(D2fin) mx.d2 <- t(round(img.d2[,,1,1],0))
if(Afin) mx.af <- t(round(img.af[,,1,1],0))
if(Ceph) mx.ce <- t(round(img.ce[,,1,1],0))
### Outline Digitization
dat.lat <- topbottom(mx.lat,Add.Tip=Add.Tip,tip.radius=tip.radius)
dat.dv <- topbottom(mx.dv,Add.Tip=Add.Tip,tip.radius=tip.radius)
if(Ffin) dat.ff <- antpost(mx.ff,Add.Tip=Add.Tip,Origin="Bottom")
if(Hfin) dat.hf <- antpost(mx.hf,Add.Tip=Add.Tip,Origin="Bottom")
if(Cfin) dat.cf <- antpost(mx.cf,Add.Tip=Add.Tip)
if(Dfin) dat.df <- antpost(mx.df,Add.Tip=Add.Tip)
if(D2fin) dat.d2 <- antpost(mx.d2,Add.Tip=Add.Tip)
if(Afin) dat.af <- antpost(mx.af,Add.Tip=Add.Tip,Origin="Bottom")
if(Ceph) dat.ce <- antpost(mx.ce,Add.Tip=Add.Tip)
### Keeping a record of original body length in pixels
bal.px <- nrow(dat.lat)
px.L <- body.axis.l/nrow(dat.lat)
if(Add.Tip) px.L <- body.axis.l/nrow(dat.lat-2)
### Whether to translate all elements vertically to center the body
y.shift <- 0
if(Body.Y.Centering) y.shift <- -mean(range(dat.lat[,2:3]))
### Interpolation, if Interpolate=TRUE
if(Interpolate){
dat.lat <- locfit_interpolate(dat.lat,Nseg=N.Body.Slice,Use.Weight=F,n.out=n.body.slice,nn=nn.b)
dat.dv <-locfit_interpolate(dat.dv,Nseg=N.Body.Slice,Use.Weight=F,n.out=n.body.slice,nn=nn.b)
if(Ffin) dat.ff <- locfit_interpolate(dat.ff,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Hfin) dat.hf <- locfit_interpolate(dat.hf,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Cfin) dat.cf <- locfit_interpolate(dat.cf,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Dfin) dat.df <- locfit_interpolate(dat.df,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(D2fin) dat.d2 <- locfit_interpolate(dat.d2,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Afin) dat.af <- locfit_interpolate(dat.af,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
if(Ceph) dat.ce <- locfit_interpolate(dat.ce,Nseg=N.Fin.Slice,n.out=n.fin.slice,nn=nn.f)
}
### Body when n=n1
mesh.body.1 <- mesh_body(dat.lat,dat.dv,nb=n1,X.center=0,Y.center=y.shift,
Z.onset=0,a.per.slice=a.per.slice,Mesh.Col=Mesh.Col,tol=Clean.Tol)
if(Save.Part.Mesh) Rvcg::vcgPlyWrite(mesh.body.1,paste0("./",Folder,"/Body_",n1,"_",
Fname.Add,".ply"),writeCol=F,writeNormals=T)
results[1,2] <- Rvcg::vcgArea(mesh.body.1)
try(results[1,1] <- Rvcg::vcgVolume(mesh.body.1))
### Body when n=n2
mesh.body.2 <- mesh_body(dat.lat,dat.dv,nb=n2,X.center=0,Y.center=y.shift,
Z.onset=0,a.per.slice=a.per.slice,Mesh.Col=Mesh.Col,tol=Clean.Tol)
if(Save.Part.Mesh) Rvcg::vcgPlyWrite(mesh.body.2,paste0("./",Folder,"/Body_",n2,"_",
Fname.Add,".ply"),writeCol=F,writeNormals=T)
results[2,2] <- Rvcg::vcgArea(mesh.body.2)
try(results[2,1] <- Rvcg::vcgVolume(mesh.body.2))
### Caudal Fluke
# Xc, Yc, Zc    Global coordinates for the caudal fluke.
# .onset        Anterior margin center of the fluke in global coordinate
if(Cfin){
# cfin.atip.y <- floor(colMeans(dat.cf[dat.cf[,2]==min(dat.cf[,2]),])[1])
cfin.atip.y <- dist(range(dat.cf[,1]))/2
# cfin.atip.y <- dat.dv[nrow(dat.dv),4]
cfin.base <- c(0, cfin.adj.up + cfin.atip.y + y.shift, cfin.onset * bal.px)
Yc.onset <- cfin.base[2] #+dat.lat[nrow(dat.lat),4]
Xc.onset <- cfin.base[1]
Zc.onset <- cfin.base[3]
mesh.cf <- mesh_foil(dat.cf,tf=cfin.thick,X.onset=Xc.onset,Y.onset=Yc.onset,
Z.onset=Zc.onset,tol=Clean.Tol,Thickest=0.5,Center=T,
a.per.slice=a.per.slice,Mesh.Col=Mesh.Col)
Mesh.Cfin <- mesh.cf$Mesh
### Fin roll, pitch, and yaw
#roll
Mesh.Cfin <- Morpho::rotaxis3d(Mesh.Cfin,cfin.base+c(0,0,100),
cfin.base+c(0,0,-100),cfin.roll)
#pitch
Mesh.Cfin <- Morpho::rotaxis3d(Mesh.Cfin,cfin.base+c(100,0,0),
cfin.base+c(-100,0,0),cfin.pitch)
#yaw
Mesh.Cfin <- Morpho::rotaxis3d(Mesh.Cfin,cfin.base+c(0,100,0),
cfin.base+c(0,-100,0),cfin.yaw)
Mesh.whole <- merge(mesh.body.1,Mesh.Cfin)
plot3d(Mesh.whole,col="royalblue",asp="iso")
### Mesh saving
if(Save.Part.Mesh) Rvcg::vcgPlyWrite(Mesh.Cfin,paste0("./",Folder,"/CaudalFluke_",
Fname.Add,".ply"),writeCol=F,writeNormals=F)
### Measure
results[3,2] <- Rvcg::vcgArea(Mesh.Cfin)
try(results[3,1] <- Rvcg::vcgVolume(Mesh.Cfin))
}
### Dorsal Fin
# Xd, Yd, Zd    Global coordinates for the dorsal fin.
# .onset        Antero-ventral corner of the dorsal fin in global coordinate
if(Dfin){
dfin.atip.y <- floor(colMeans(dat.df[dat.df[,2]==min(dat.df[,2]),])[1])
dfin.bheight <- -dat.lat[floor(dfin.onset*bal.px),2] - y.shift
dfin.base <- c(0, dfin.adj.up + dfin.bheight -dfin.atip.y, dfin.onset * bal.px)
Zd.onset <- dfin.base[3]
Xd.onset <- dfin.base[1]
Yd.onset <- dfin.base[2]
mesh.df <- mesh_foil(dat.df,tf=dfin.thick,X.onset=Xd.onset,Y.onset=Yd.onset,
Z.onset=Zd.onset,tol=Clean.Tol,Thickest=0.1,Center=F,
a.per.slice=a.per.slice,Mesh.Col=Mesh.Col)
Mesh.Dfin <- mesh.df$Mesh
### Fin roll, pitch, and yaw
#roll
Mesh.Dfin <- Morpho::rotaxis3d(Mesh.Dfin,dfin.base+c(0,0,100),
dfin.base+c(0,0,-100),dfin.roll)
#pitch
Mesh.Dfin <- Morpho::rotaxis3d(Mesh.Dfin,dfin.base+c(100,0,0),
dfin.base+c(-100,0,0),dfin.pitch)
#yaw
Mesh.Dfin <- Morpho::rotaxis3d(Mesh.Dfin,dfin.base+c(0,100,0),
dfin.base+c(0,-100,0),dfin.yaw)
### Mesh saving
if(Save.Part.Mesh) Rvcg::vcgPlyWrite(Mesh.Dfin,paste0("./",Folder,"/DorsalFin_",
name.Add,".ply"),writeCol=F,writeNormals=F)
### Measure
results[4,2] <- Rvcg::vcgArea(Mesh.Dfin)
try(results[4,1] <- Rvcg::vcgVolume(Mesh.Dfin))
}
dfin.atip.y <- floor(colMeans(dat.df[dat.df[,2]==min(dat.df[,2]),])[1])
dfin.bheight <- -dat.lat[floor(dfin.onset*bal.px),2] - y.shift
dfin.base <- c(0, dfin.adj.up + dfin.bheight -dfin.atip.y, dfin.onset * bal.px)
Zd.onset <- dfin.base[3]
Xd.onset <- dfin.base[1]
Yd.onset <- dfin.base[2]
mesh.df <- mesh_foil(dat.df,tf=dfin.thick,X.onset=Xd.onset,Y.onset=Yd.onset,
Z.onset=Zd.onset,tol=Clean.Tol,Thickest=0.1,Center=F,
a.per.slice=a.per.slice,Mesh.Col=Mesh.Col)
Mesh.Dfin <- mesh.df$Mesh
mesh.df <- mesh_foil(dat.df,tf=dfin.thick,X.onset=Xd.onset,Y.onset=Yd.onset,
Z.onset=Zd.onset,tol=Clean.Tol,Thickest=0.1,Center=F,
a.per.slice=a.per.slice,Mesh.Col=Mesh.Col)
dat.fin <- dat.df
v <- dat.fin$coord
n.left <- round(max(v)*Thickest,0)
n.right <- length(v)-n.left
v.thick <- c(seq(0,1,length.out=n.left),seq(1,0,length.out=n.right))
Thickest=0.5
a.per.slice=181
Mesh.Col="royalblue"
Center=T
tol=0.0001
Z.onset=0
Y.onset=0
X.onset=0
Cephalofoil=F
v <- dat.fin$coord
n.left <- round(max(v)*Thickest,0)
n.right <- length(v)-n.left
v.thick <- c(seq(0,1,length.out=n.left),seq(1,0,length.out=n.right))
if(Cephalofoil){
n.left <- n.right <- round(length(v)*0.04)
n.mid <- length(v)-n.left-n.right
hn.mid <-n.mid %/% 2
qn.mid <-n.mid %/% 4
thin <- 0.7
v.thick <- c(seq(0,1,length.out=n.left),seq(1,thin,length.out=qn.mid),
seq(thin,1,length.out=qn.mid),rep(thin,n.mid %% 4),
seq(1,thin,length.out=qn.mid),seq(thin,1,length.out=qn.mid),
seq(1,0,length.out=n.right))
}
if(Center) v <- v-mean(v)
Mf <- plot3D::mesh(seq(-pi,pi,length.out=a.per.slice),seq(1,nrow(dat.fin)))
u <- (cos(Mf$x)+1)/2
y <- matrix(v[Mf$y],nrow(Mf$y),ncol(Mf$y))
y.thick <- matrix(v.thick[Mf$y],nrow(Mf$y),ncol(Mf$y))
z <- 2 * dat.fin$radius[Mf$y] * u + dat.fin$ant[Mf$y]
# Tf <- tf * ((1-abs(y/max(y)))^0.5)
# if(Thick=="Top") Tf <- tf * (abs(y/max(y)))^0.5
Tf <- tf * (y.thick^0.5)
x <- sign(sin(Mf$x)) * 5 * Tf * (0.2969 * (u^0.5) - 0.1260 * u -
0.3516 * (u^2) + 0.2843 * (u^3) - 0.1036 * (u^4))
tf=20
if(Center) v <- v-mean(v)
Mf <- plot3D::mesh(seq(-pi,pi,length.out=a.per.slice),seq(1,nrow(dat.fin)))
u <- (cos(Mf$x)+1)/2
y <- matrix(v[Mf$y],nrow(Mf$y),ncol(Mf$y))
y.thick <- matrix(v.thick[Mf$y],nrow(Mf$y),ncol(Mf$y))
z <- 2 * dat.fin$radius[Mf$y] * u + dat.fin$ant[Mf$y]
# Tf <- tf * ((1-abs(y/max(y)))^0.5)
# if(Thick=="Top") Tf <- tf * (abs(y/max(y)))^0.5
Tf <- tf * (y.thick^0.5)
x <- sign(sin(Mf$x)) * 5 * Tf * (0.2969 * (u^0.5) - 0.1260 * u -
0.3516 * (u^2) + 0.2843 * (u^3) - 0.1036 * (u^4))
X <- x + X.onset
Y <- y + Y.onset
Z <- z + Z.onset
rgl::open3d()
rgl::surface3d(X, Y, Z, col=Mesh.Col, smooth=TRUE,asp="iso")
mesh_foil <- rgl::as.mesh3d()
rgl::close3d()
mesh_foil <- mesh_nan_replace(mesh_foil,a.per.slice=a.per.slice,
tip.radius=tip.radius)
mesh_foil <- Rvcg::vcgClean(mesh_foil,sel=0:7,iterate=F,tol=tol)
# mesh_foil <- vcgClean(mesh_foil,sel=c(6),iterate=F,tol=tol)
# mesh_foil <- vcgClean(mesh_foil,sel=c(0:4,6:7),iterate=F)
return(invisible(list(Mesh=mesh_foil,X=X,Y=Y,Z=Z)))
X.onset=Xd.onset
Y.onset=Yd.onset
Z.onset=Zd.onset
tol=Clean.Tol
a.per.slice=a.per.slice
v <- dat.fin$coord
n.left <- round(max(v)*Thickest,0)
n.right <- length(v)-n.left
v.thick <- c(seq(0,1,length.out=n.left),seq(1,0,length.out=n.right))
if(Cephalofoil){
n.left <- n.right <- round(length(v)*0.04)
n.mid <- length(v)-n.left-n.right
hn.mid <-n.mid %/% 2
qn.mid <-n.mid %/% 4
thin <- 0.7
v.thick <- c(seq(0,1,length.out=n.left),seq(1,thin,length.out=qn.mid),
seq(thin,1,length.out=qn.mid),rep(thin,n.mid %% 4),
seq(1,thin,length.out=qn.mid),seq(thin,1,length.out=qn.mid),
seq(1,0,length.out=n.right))
}
if(Center) v <- v-mean(v)
Mf <- plot3D::mesh(seq(-pi,pi,length.out=a.per.slice),seq(1,nrow(dat.fin)))
u <- (cos(Mf$x)+1)/2
y <- matrix(v[Mf$y],nrow(Mf$y),ncol(Mf$y))
y.thick <- matrix(v.thick[Mf$y],nrow(Mf$y),ncol(Mf$y))
z <- 2 * dat.fin$radius[Mf$y] * u + dat.fin$ant[Mf$y]
# Tf <- tf * ((1-abs(y/max(y)))^0.5)
# if(Thick=="Top") Tf <- tf * (abs(y/max(y)))^0.5
Tf <- tf * (y.thick^0.5)
x <- sign(sin(Mf$x)) * 5 * Tf * (0.2969 * (u^0.5) - 0.1260 * u -
0.3516 * (u^2) + 0.2843 * (u^3) - 0.1036 * (u^4))
X <- x + X.onset
Y <- y + Y.onset
Z <- z + Z.onset
rgl::open3d()
rgl::surface3d(X, Y, Z, col=Mesh.Col, smooth=TRUE,asp="iso")
mesh_foil <- rgl::as.mesh3d()
rgl::close3d()
X
Y
Z
is.na(Y)
Y[1:20,1:20]
v <- dat.fin$coord
n.left <- round(max(v)*Thickest,0)
n.right <- length(v)-n.left
v.thick <- c(seq(0,1,length.out=n.left),seq(1,0,length.out=n.right))
if(Cephalofoil){
n.left <- n.right <- round(length(v)*0.04)
n.mid <- length(v)-n.left-n.right
hn.mid <-n.mid %/% 2
qn.mid <-n.mid %/% 4
thin <- 0.7
v.thick <- c(seq(0,1,length.out=n.left),seq(1,thin,length.out=qn.mid),
seq(thin,1,length.out=qn.mid),rep(thin,n.mid %% 4),
seq(1,thin,length.out=qn.mid),seq(thin,1,length.out=qn.mid),
seq(1,0,length.out=n.right))
}
if(Center) v <- v-mean(v)
Mf <- plot3D::mesh(seq(-pi,pi,length.out=a.per.slice),seq(1,nrow(dat.fin)))
u <- (cos(Mf$x)+1)/2
y <- matrix(v[Mf$y],nrow(Mf$y),ncol(Mf$y))
y
y[1:20,1:20]
y.thick <- matrix(v.thick[Mf$y],nrow(Mf$y),ncol(Mf$y))
y.thick
y.thick[1:20,1:20]
z <- 2 * dat.fin$radius[Mf$y] * u + dat.fin$ant[Mf$y]
z
# Tf <- tf * ((1-abs(y/max(y)))^0.5)
# if(Thick=="Top") Tf <- tf * (abs(y/max(y)))^0.5
Tf <- tf * (y.thick^0.5)
x <- sign(sin(Mf$x)) * 5 * Tf * (0.2969 * (u^0.5) - 0.1260 * u -
0.3516 * (u^2) + 0.2843 * (u^3) - 0.1036 * (u^4))
x
x[1:30:1:20]
x[1;30,1:20]
x[1:30,1:20]
X <- x + X.onset
Y <- y + Y.onset
Z <- z + Z.onset
Y
y
Y.onset
Yd.onset
dfin.atip.y <- floor(colMeans(dat.df[dat.df[,2]==min(dat.df[,2]),])[1])
dfin.bheight <- -dat.lat[floor(dfin.onset*bal.px),2] - y.shift
dfin.base <- c(0, dfin.adj.up + dfin.bheight -dfin.atip.y, dfin.onset * bal.px)
dfin.base
dfin.adj.up
dfin.bheight
dfin.atip.y
dat.lat[floor(dfin.onset*bal.px),2]
y.shift
floor(dfin.onset*bal.px)
dfin.onset
load("P:/My Documents/MANU/Paleomass2/R/Sphyrna.rda")
load("P:/My Documents/MANU/Paleomass2/R/Stenopterygius.rda")
load("P:/My Documents/MANU/Paleomass2/R/Plesiopteryx.rda")
Sphyrna
use_data(Sphyrna)
library(devtools)
use_data(Sphyrna)
use_data(Sphyrna,overwrite=T)
use_data(Stenopterygius,overwrite=T)
use_data(Plesiopteryx,overwrite=T)
